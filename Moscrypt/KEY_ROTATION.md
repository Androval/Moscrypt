# Key Rotation System for Moscrypt

This document was generated by AI, please take what it says with a grain of salt.

This document explains the key rotation system implemented in Moscrypt, which allows secure rotation of cryptographic keys without data loss.

## Overview

Key rotation is a security best practice that involves periodically changing encryption keys to:

1. Limit the window of opportunity if a key is compromised
2. Comply with security standards and regulations
3. Mitigate the risk of undetected compromises
4. Enforce least privilege and separation of duties

## Key Hierarchy in Moscrypt

Moscrypt uses a hierarchical key system:

```
Master Key (in .env)
    |
    ├── Purpose-specific Keys (derived)
    |       |
    |       └── Data Encryption Keys
    |
    └── User KEKs
            |
            └── Session Keys
                  |
                  └── Messages/Files
```

- **Master Key**: The root key stored in the `.env` file
- **Purpose-specific Keys**: Derived from the master key for different functions
- **User KEKs**: Key Encryption Keys for each user
- **Session Keys**: Generated for each key session
- **Data Encryption Keys**: Used to encrypt actual files and messages

## Key Rotation Process

The key rotation process involves:

1. **Preparation**:
   - Database schema migration to add `key_version` fields 
   - Backup of current environment variables

2. **Rotation**:
   - Generation of a new master key
   - Re-encryption of all keys with the new master key
   - Update of the `.env` file

3. **Verification**:
   - Testing access to previously encrypted data
   - Logging of key rotation events

## How to Rotate Keys

### Prerequisites

Before rotating keys:

1. Create a full backup of your database
2. Ensure all services are stopped
3. Install the required dependencies:
   ```
   pip install -r requirements.txt
   ```

### Step 1: Prepare the Database

Run the migration script to add key version tracking:

```bash
python migrate_key_version.py
```

### Step 2: Perform Key Rotation

Use the key rotation script:

```bash
python key_rotation.py
```

For automated environments, use the `--force` flag to skip confirmation:

```bash
python key_rotation.py --force
```

For testing without making changes, use the `--dry-run` flag:

```bash
python key_rotation.py --dry-run
```

### Step 3: Restart Services

After successful key rotation, restart all services to use the new key:

```bash
supervisorctl restart moscrypt
```

## Troubleshooting

If issues occur during key rotation:

1. Restore the `.env` file from the backup created during rotation
2. Restore the database from backup if necessary
3. Check the `key_rotation.log` file for error messages

## Key Rotation Schedule

Best practices for key rotation frequency:

| Key Type | Recommended Rotation Frequency |
|----------|--------------------------------|
| Master Key | Every 1 year |
| User KEKs | When compromised or employee role changes |
| Session Keys | New key for each session |

## Emergency Key Rotation

In case of a suspected key compromise:

1. Immediately perform key rotation
2. Revoke any potentially compromised user KEKs
3. Create new key sessions for sensitive data
4. Document the incident and response

## Implementation Details

The key rotation system uses:

- **Key Versioning**: Each encrypted entity stores the version of the key used
- **Key Derivation**: Purpose-specific keys are derived from the master key
- **Safe Update Process**: Backup and atomic updates prevent data loss

## Security Considerations

- Never delete old keys until all data has been re-encrypted
- Protect backup files containing old keys
- Use secure key storage (HSM in production if possible)
- Log all key rotation operations for audit 